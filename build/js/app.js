var INITIAL_LATITUDE=37.7833,INITIAL_LONGITUDE=-122.4167,NUMBER_OF_PHOTOS_TO_SHOW=3,BasicGoogleMapManager=function(e){this.currentlySelectedMarker=null,this.currentInfoWindowContentString="",this.mapOptions={center:{lat:INITIAL_LATITUDE,lng:INITIAL_LONGITUDE},zoom:12,zoomControl:!0,disableDefaultUI:!0},this.map=new google.maps.Map(document.getElementById("map-canvas"),this.mapOptions),this.infoWindow=new google.maps.InfoWindow({maxWidth:260}),this.infoWindow.context=e};BasicGoogleMapManager.prototype.centerMap=function(e){this.map.setCenter(e)},BasicGoogleMapManager.prototype.panMap=function(e,t){this.map.panBy(e,t)},BasicGoogleMapManager.prototype.resetInfoWindowContent=function(e){this.currentInfoWindowContentString=e,this.infoWindow.setContent(e)},BasicGoogleMapManager.prototype.appendInfoWindowContent=function(e){this.currentInfoWindowContentString=this.currentInfoWindowContentString+e,this.infoWindow.setContent(this.currentInfoWindowContentString)},BasicGoogleMapManager.prototype.openInfoWindow=function(e){this.infoWindow.open(this.map,e)},BasicGoogleMapManager.prototype.closeInfoWindow=function(){this.infoWindow.close()},BasicGoogleMapManager.prototype.createMarker=function(e,t,o){var n=new google.maps.LatLng(e,t),a=new google.maps.Marker({map:this.map,draggable:!1,position:n,optimized:!1,icon:"images/carrot_in_ground.png"});return a.customData=o,a},BasicGoogleMapManager.prototype.showMarker=function(e){e.setVisible(!0)},BasicGoogleMapManager.prototype.hideMarker=function(e){e.setVisible(!1)},BasicGoogleMapManager.prototype.selectMarker=function(e){this.currentlySelectedMarker&&this.currentlySelectedMarker.setIcon("images/carrot_in_ground.png"),this.currentlySelectedMarker=e,this.currentlySelectedMarker.setIcon("images/carrot_picked_with_face.gif")},BasicGoogleMapManager.prototype.deselectMarker=function(){this.currentlySelectedMarker&&(this.currentlySelectedMarker.setIcon("images/carrot_in_ground.png"),this.currentlySelectedMarker=null)};var ViewModel=function(){function e(e,o){$.ajax({type:"GET",contentType:"application/json; charset=utf-8",url:"http://search.ams.usda.gov/farmersmarkets/v1/data.svc/locSearch?lat="+e+"&lng="+o,dataType:"jsonp"}).done(function(e){l=!0;for(var o=0;o<e.results.length;o++){var n={marketName:e.results[o].marketname.substring(e.results[o].marketname.indexOf(" ")+1),marketID:e.results[o].id};t(n)}}).fail(function(){alert("fail: Error getting farmers market data from usda.gov")})}function t(e){$.ajax({type:"GET",contentType:"application/json; charset=utf-8",url:"http://search.ams.usda.gov/farmersmarkets/v1/data.svc/mktDetail?id="+e.marketID,context:e,dataType:"jsonp",cache:!1}).done(function(e){if(e){var t=e.marketdetails,o=t.GoogleLink,a=o.indexOf("?q=")+3,r=o.indexOf("%2C%20"),c=r+6,l=o.lastIndexOf("%20");this.lat=o.substring(a,r),this.lng=o.substring(c,l),this.address=t.Address,this.schedule=t.Schedule,this.products=t.Products,this.mapMarker=i.createMarker(this.lat,this.lng,this),s.placesList.push(this),n(this.mapMarker)}}).fail(function(){alert("Error getting farmers market detail data from usda.gov")})}function o(e){a(e),i.selectMarker(e.mapMarker),i.centerMap(e.mapMarker.getPosition()),window.innerHeight<=720&&i.panMap(-60,-150),window.innerWidth<=1020&&s.toggleMenuBoolean(!1)}function n(e){google.maps.event.addListener(e,"click",function(){o(e.customData)})}function a(e){var t;t=window.innerHeight>720?"<h4>"+e.marketName+"</h4><br><h4>"+e.address+"</h4><br>Schedule: "+e.schedule.replace(/\<br\>/g,"")+"<br>Products: "+e.products+"<br><br>":"<h4>"+e.marketName+"</h4><br><h4>"+e.address+"</h4><br>Schedule: "+e.schedule.replace(/\<br\>/g,"")+"<br><br>",i.resetInfoWindowContent(t),p(e.marketName),i.openInfoWindow(e.mapMarker)}function r(){i=new BasicGoogleMapManager(s),i.map?(google.maps.event.addListener(i.infoWindow,"closeclick",function(){i.deselectMarker()}),s.googlePlacesSearch=new google.maps.places.SearchBox(document.getElementById("location-box")),google.maps.event.addListener(s.googlePlacesSearch,"places_changed",locationInputHandler),setTimeout(function(){l||alert("Error getting farmers market data from usda.gov")},8e3),e(INITIAL_LATITUDE,INITIAL_LONGITUDE)):alert("failed to load Google map - check your internet connection or firewall settings")}var i,s=this,c=[],l=!1;s.placesList=ko.observableArray([]),s.filterInput=ko.observable(),s.toggleMenuBoolean=ko.observable(!0);var p=function(e){var t=e.replace(/'/g,""),o="https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key=376b144109ffe90065a254606c9aae3d&&tags=",n="&tag_mode=all&sort=interestingness-desc&safe_search=1&extras=date_taken&format=json&nojsoncallback=1",a=o+t+n;$.ajax({type:"GET",url:a,dataType:"json",success:function(e){d(e.photos.photo)},error:function(){g()}})},d=function(e){var t,o,n;if(e.length>0){i.appendInfoWindowContent("Flickr Photos (click to open photo in new window)<br>");for(var a=0;NUMBER_OF_PHOTOS_TO_SHOW>a;a++)e[a]&&(t=e[a],o="https://farm"+t.farm+".staticflickr.com/"+t.server+"/"+t.id+"_"+t.secret+"_s.jpg",n="https://farm"+t.farm+".staticflickr.com/"+t.server+"/"+t.id+"_"+t.secret+".jpg",i.appendInfoWindowContent("<a href="+n+' target="_blank"><img class="photo" src='+o+">"))}else i.appendInfoWindowContent("No Flickr Photos Found<br>")},g=function(){i.appendInfoWindowContent("Error retrieving Flickr photos<br>")};filterInputHandler=function(){var e,t,o,n;if(e=s.filterInput()){i.deselectMarker(),i.closeInfoWindow(),restorePlacesList(),e=e.toLowerCase(),t=s.placesList().length;for(var a=t-1;a>=0;a--)o=s.placesList()[a],n=o.marketName+" "+o.address+" "+o.products+" "+o.schedule,n=n.toLowerCase(),-1==n.indexOf(e)&&(i.hideMarker(o.mapMarker),s.placesList.remove(o),c.push(o))}else restorePlacesList()},restorePlacesList=function(){var e,t;e=c.length;for(var o=e-1;o>=0;o--)t=c.pop(),i.showMarker(t.mapMarker),s.placesList.push(t)},locationInputHandler=function(){var t,o;t=s.googlePlacesSearch.getPlaces(),t.length>0?(clearPlacesList(),i.deselectMarker(),i.closeInfoWindow(),o=t[0].geometry.location,i.centerMap(o),e(o.lat(),o.lng())):alert("No matching locations")},clearPlacesList=function(){var e;e=s.placesList().length;for(var t=e-1;t>=0;t--)currentPlace=s.placesList.pop(),currentPlace.mapMarker.setMap(null)},menuToggleHandler=function(){s.toggleMenuBoolean(s.toggleMenuBoolean()?!1:!0)},s.listClickHandler=function(e){o(e)},window.google?google.maps.event.addDomListener(window,"load",r):alert("Google maps unavailable - check your internet connection or firewall settings and reload")};ko.applyBindings(new ViewModel);